---
title: "Lending Data"
author: "Carole Voulgaris & Yoji Toriumi"
date: "2/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(fs)
```


## Load data

Multifamily census tract files: https://www.fhfa.gov/DataTools/Downloads/Pages/Multifamily-Census-Tract-File.aspx

Single family census tract files:
https://www.fhfa.gov/DataTools/Downloads/Pages/Single-Family-Census-Tract-File.aspx

Download the zip file and extract it to a folder in your project directory called `raw_datasets` (listed in the GitIgnore file)

See the included data dictionary for a list of variable descriptions.

Here's an example where I read in a couple files (Fannie Mae and Freddie Mac data for 2020) and just count the total number of loans in each census tract for that one year.

```{r}
# since data structure are different in 2008-2009, 2010-2017, and 2018-2020, prepare three col names for multi-family data
mf_08_09_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "UndAreaIndi",
           "LienStat"
           )

mf_10_17_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "LienStat"
           )

mf_18_20_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "LienStat",
           "LTV",
           "NoteDate",
           "Term",
           "numUnits",
           "rate",
           "amt",
           "propVal",
           "prepayPenalty",
           "balloon",
           "interestOnly",
           "negAmort",
           "other",
           "pctAfford",
           "constMethod",
           "Rural",
           "MissDelta",
           "Appalachia",
           "persPov",
           "consPov",
           "HiOpp",
           "QOZ")

# import multi-family data
for (i in c(2008:2009)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2008:2009)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}
```

```{r}
# since data structure are different in 2008-2009, 2010-2017, and 2018-2020, prepare three col names for single-family data. Data structure of single-family is a bit different from multi-family. 
sf_08_09_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "UndAreaIndi",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat"
           )

sf_10_17_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat"
           )

sf_18_20_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat",
           "Over62",
           "CoBoOver62",
           "LTV",
           "NoteDate",
           "Term",
           "numUnits",
           "rate",
           "amt",
           "Preapproval",
           "AppliChannel",
           "AUS",
           "CreditScoreBo",
           "CreditScoreCoBo",
           "DTIRatio",
           "DiscountPoints",
           "IntroRatePeriod",
           "LandProperyInterest",
           "propVal",
           "Rural",
           "MissDelta",
           "Appalachia",
           "persPov",
           "consPov",
           "HiOpp",
           "QOZ")


for (i in c(2008:2009)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2008:2009)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}
```

```{r}
# bind multi-family and single family data
mf_data <-
  bind_rows(
    mf_2008_fhlmc,
    mf_2009_fhlmc,
    mf_2010_fhlmc,
    mf_2011_fhlmc,
    mf_2012_fhlmc,
    mf_2013_fhlmc,
    mf_2014_fhlmc,
    mf_2015_fhlmc,
    mf_2016_fhlmc,
    mf_2017_fhlmc,
    mf_2018_fhlmc,
    mf_2019_fhlmc,
    mf_2020_fhlmc,
    mf_2008_fnma,
    mf_2009_fnma,
    mf_2010_fnma,
    mf_2011_fnma,
    mf_2012_fnma,
    mf_2013_fnma,
    mf_2014_fnma,
    mf_2015_fnma,
    mf_2016_fnma,
    mf_2017_fnma,
    mf_2018_fnma,
    mf_2019_fnma,
    mf_2020_fnma
  )%>%
      mutate(FamilyType = "mf")

sf_2008_2017_data <-
  bind_rows(
    sf_2008_fhlmc,
    sf_2009_fhlmc,
    sf_2010_fhlmc,
    sf_2011_fhlmc,
    sf_2012_fhlmc,
    sf_2013_fhlmc,
    sf_2014_fhlmc,
    sf_2015_fhlmc,
    sf_2016_fhlmc,
    sf_2017_fhlmc,
    sf_2018_fhlmc,
    sf_2019_fhlmc,
    sf_2020_fhlmc,
    sf_2008_fnma,
    sf_2009_fnma,
    sf_2010_fnma,
    sf_2011_fnma,
    sf_2012_fnma,
    sf_2013_fnma,
    sf_2014_fnma,
    sf_2015_fnma,
    sf_2016_fnma,
    sf_2017_fnma)

sf_2008_2017_data$Age <- as.numeric(cut(sf_2008_2017_data$Age,
       breaks = c(0, 24, 34, 44, 54, 64, 74, 110, 999),
    labels = c(1, 2, 3, 4, 5, 6, 7, 9)))

sf_data <-
  bind_rows(
    sf_2008_2017_data,
    sf_2018_fnma,
    sf_2019_fnma,
    sf_2020_fnma
  ) %>%
      mutate(FamilyType = "sf")

data <- bind_rows(sf_data, mf_data)

write_csv(sf_data, "sf_loan_data.csv")
write_csv(mf_data, "mf_loan_data.csv")
write_csv(data, "loan_data.csv")
```

```{r}
tract_loans <- data %>%
  filter(State == '42',
         County == '003') %>%
  group_by(Tract) %>%
  summarise(num_loans = n())

tract_loans
```


## Tasks

* Load data files for all years (use `rbind()`).
* Generate a summary dataframe with the following variables at the census tract level:
    + Average number of single-family loans per year
```{r}
sf_avg_year <- data %>%
  filter(FamilyType == "sf") %>% 
  group_by(year) %>% 
  summarise(num_loans = n())

ggplot(sf_avg_year) +
  geom_bar(aes(as.character(year), num_loans), stat = "identity") +
  labs(x = "Year", y = "Number of loans", title = "Number of single-family loans per year") +
  theme_classic() +
  geom_hline(yintercept = mean(sf_avg_year$num_loans), color = "red")
```

    + Average number of multifamily loans per year
```{r}
mf_avg_year <- data %>%
  filter(FamilyType == "mf") %>% 
  group_by(year) %>% 
  summarise(num_loans = n())

ggplot(mf_avg_year) +
  geom_bar(aes(as.character(year), num_loans), stat = "identity") +
  labs(x = "Year", y = "Number of loans", title = "Number of multi-family loans per year") +
  theme_classic() +
  geom_hline(yintercept = mean(mf_avg_year$num_loans), color = "red")
```

    + Average number of loans per year by loan purpose
```{r}
data$Purpose <- as.character(data$Purpose)
avg_year_purpose <- data %>% 
  group_by(year, Purpose) %>% 
  summarise(num_loans = n())

ggplot(avg_year_purpose) +
  geom_bar(aes(x = year, y = num_loans, fill = Purpose), 
           stat = "identity", position = position_dodge(width = 1)) +
  labs(x = "Year", y = "Number of loans", title = "Number of purpose-wise loans per year") +
  scale_fill_hue(labels = c("Purchase", "Refinancing(non cash-out)", "Home Improvement", "Refinancing (cash-out)", "Not applicable/Not available"))
```

    + Average number of units for multifamily loans
```{r}
avg_nunits <- data %>% 
  filter(FamilyType == "mf" & numUnits != "NA")

avg_nunits <- (
  sum(avg_nunits$numUnits == 1) * (5 + 24) / 2 +
    sum(avg_nunits$numUnits == 2) * (25 + 50) / 2 +
    sum(avg_nunits$numUnits == 3) * (51 + 99) / 2 +
    sum(avg_nunits$numUnits == 4) * (100 + 149) / 2 +
    sum(avg_nunits$numUnits == 5) * (200) / 20
) /
  sum(avg_nunits$numUnits != 9)

data %>% 
  filter(FamilyType == "mf" & numUnits != "NA") %>%
  ggplot() +
  geom_bar(aes(x = year, fill = as.character(numUnits)), 
           position = position_dodge(width = 1)) +
  labs(x = "Year", y = "Count", title = "Number of units for multi-family loans per year", fill = "Number of units") +
  scale_fill_hue(labels = c("5-24", "25-50", "51-99", "100-149", "over 149", "Unknown"))
```

    + Average percent of affordable units
```{r}
avgpct_afford <- data %>% 
  filter(pctAfford != "NA") %>% 
  summarize(mean(pctAfford))
  
avgpct_afford
```

    + Is it an opportunity zone?
```{r}
opp_zone <- data %>% 
  filter(QOZ != "NA") %>% 
  summarize(mean(QOZ))

opp_zone
```

    + Other tract-level variables about lending you think could be interesting?

```{r}
data %>% group_by(EntFlag) %>%
  filter(BorrowersIncome < 9999999) %>%
  ggplot() + 
  geom_jitter(aes(x = as.factor(EntFlag), y = BorrowersIncome)) +
  labs(x = "Enterprise type", y = "Borrower's income", title = "Enterprise-wise borrowers income") +
  scale_x_discrete(labels = c("Fannie Mae", "Freddie Mac")) +
  ylim(0, 1250000)
```

```{r}
data %>% filter(Race_1 <= 5, BorrowersIncome <= 250000) %>%
  ggplot() +
  geom_boxplot(aes(as.factor(Race_1), BorrowersIncome)) +
  labs(x = "Race", y = "Borrower's income", title = "Race-wise borrowers income") +
  scale_x_discrete(labels = c("American Indian or Alaska Native", "Asian", "African American", "Native Hawaiian", "White")) 
```



