---
title: "Lending Data"
author: "Carole Voulgaris & Yoji Toriumi"
date: "2/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(tidycensus)
library(tigris)
library(sf)
library(fs)
library(modeest)
library(ggspatial)
library(ggthemes)
library(scales) 
```


## Load data

Multifamily census tract files: https://www.fhfa.gov/DataTools/Downloads/Pages/Multifamily-Census-Tract-File.aspx

Single family census tract files:
https://www.fhfa.gov/DataTools/Downloads/Pages/Single-Family-Census-Tract-File.aspx

Download the zip file and extract it to a folder in your project directory called `raw_datasets` (listed in the GitIgnore file)

See the included data dictionary for a list of variable descriptions.

Here's an example where I read in a couple files (Fannie Mae and Freddie Mac data for 2020) and just count the total number of loans in each census tract for that one year.

```{r}
# since data structure are different in 2008-2009, 2010-2017, and 2018-2020, prepare three col names for multi-family data
mf_08_09_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "UndAreaIndi",
           "LienStat"
           )

mf_10_17_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "LienStat"
           )

mf_18_20_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "areaMedFamInc",
           "UPB",
           "Purpose",
           "InstType",
           "FedGuaran",
           "LienStat",
           "LTV",
           "NoteDate",
           "Term",
           "numUnits",
           "rate",
           "amt",
           "propVal",
           "prepayPenalty",
           "balloon",
           "interestOnly",
           "negAmort",
           "other",
           "pctAfford",
           "constMethod",
           "Rural",
           "MissDelta",
           "Appalachia",
           "persPov",
           "consPov",
           "HiOpp",
           "QOZ")

# import multi-family data
for (i in c(2008:2009)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2008:2009)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),
    col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("mf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fnma_mf", i, "c_loans.txt", sep = "")
    ),col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("mf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_MFCensusTract", i, sep = ""),
      paste("fhlmc_mf", i, "c_loans.txt", sep = "")
    ),col_types = cols("number","character","character","number","character","character","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number","number"),
    show_col_types = FALSE) %>%
      setNames(mf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}
```

```{r}
# since data structure are different in 2008-2009, 2010-2017, and 2018-2020, prepare three col names for single-family data. Data structure of single-family is a bit different from multi-family. 
sf_08_09_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "UndAreaIndi",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat"
           )

sf_10_17_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat"
           )

sf_18_20_names <- c("EntFlag",
           "RecNo",
           "State",
           "MSA",
           "County",
           "Tract",
           "PctMinority",
           "MedIncome",
           "areaMedIncome",
           "TractIncomeRatio",
           "BorrowersIncome",
           "areaMedFamInc",
           "BorrowerIncomeRatio",
           "UPB",
           "Purpose",
           "FedGuaran",
           "NumBorrower",
           "FirstBuyer",
           "Race_1",
           "Race_2",
           "Race_3",
           "Race_4",
           "Race_5",
           "Ethnicity",
           "CoBoRace_1",
           "CoBoRace_2",
           "CoBoRace_3",
           "CoBoRace_4",
           "CoBoRace_5",
           "CoBoEthnicity",
           "Gender",
           "CoBoGender",
           "Age",
           "CoBoAge",
           "Occupancy",
           "RateSpread",
           "Hoepa",
           "PropertyType",
           "LienStat",
           "Over62",
           "CoBoOver62",
           "LTV",
           "NoteDate",
           "Term",
           "numUnits",
           "rate",
           "amt",
           "Preapproval",
           "AppliChannel",
           "AUS",
           "CreditScoreBo",
           "CreditScoreCoBo",
           "DTIRatio",
           "DiscountPoints",
           "IntroRatePeriod",
           "LandProperyInterest",
           "propVal",
           "Rural",
           "MissDelta",
           "Appalachia",
           "persPov",
           "consPov",
           "HiOpp",
           "QOZ")


for (i in c(2008:2009)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2008:2009)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_10_17_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2010:2017)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_08_09_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("sf_", i, "_fhlmc")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFRE", i, sep = ""),
      paste("fhlmc_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}

for (i in c(2018:2020)) {
  filename <- paste0("sf_", i, "_fnma")
  assign(
    filename,
    read_fwf(path(
      "raw_datasets",
      paste(i, "_SFCensusTractFNM", i, sep = ""),
      paste("fnma_sf", i, "c_loans.txt", sep = "")
    ),
    show_col_types = FALSE) %>%
      setNames(sf_18_20_names) %>%
      filter(State == '42',
             County == '003') %>%
      mutate(year = i)
  )
}
```

```{r}
# bind multi-family and single family data
mf_data <-
  bind_rows(
    mf_2008_fhlmc,
    mf_2009_fhlmc,
    mf_2010_fhlmc,
    mf_2011_fhlmc,
    mf_2012_fhlmc,
    mf_2013_fhlmc,
    mf_2014_fhlmc,
    mf_2015_fhlmc,
    mf_2016_fhlmc,
    mf_2017_fhlmc,
    mf_2018_fhlmc,
    mf_2019_fhlmc,
    mf_2020_fhlmc,
    mf_2008_fnma,
    mf_2009_fnma,
    mf_2010_fnma,
    mf_2011_fnma,
    mf_2012_fnma,
    mf_2013_fnma,
    mf_2014_fnma,
    mf_2015_fnma,
    mf_2016_fnma,
    mf_2017_fnma,
    mf_2018_fnma,
    mf_2019_fnma,
    mf_2020_fnma
  )%>%
      mutate(FamilyType = "mf")

sf_2008_2017_data <-
  bind_rows(
    sf_2008_fhlmc,
    sf_2009_fhlmc,
    sf_2010_fhlmc,
    sf_2011_fhlmc,
    sf_2012_fhlmc,
    sf_2013_fhlmc,
    sf_2014_fhlmc,
    sf_2015_fhlmc,
    sf_2016_fhlmc,
    sf_2017_fhlmc,
    sf_2018_fhlmc,
    sf_2019_fhlmc,
    sf_2020_fhlmc,
    sf_2008_fnma,
    sf_2009_fnma,
    sf_2010_fnma,
    sf_2011_fnma,
    sf_2012_fnma,
    sf_2013_fnma,
    sf_2014_fnma,
    sf_2015_fnma,
    sf_2016_fnma,
    sf_2017_fnma)

# transform continuous age variable to categorical variable
sf_2008_2017_data$Age <- as.numeric(cut(sf_2008_2017_data$Age,
       breaks = c(0, 24, 34, 44, 54, 64, 74, 120, 121, 999),
    labels = c(1, 2, 3, 4, 5, 6, 7, 8, 9)))

sf_2008_2017_data$CoBoAge <- as.numeric(cut(sf_2008_2017_data$CoBoAge,
       breaks = c(0, 24, 34, 44, 54, 64, 74, 120, 121, 999),
    labels = c(1, 2, 3, 4, 5, 6, 7, 8, 9)))

sf_data <-
  bind_rows(
    sf_2008_2017_data,
    sf_2018_fnma,
    sf_2019_fnma,
    sf_2020_fnma
  ) %>%
      mutate(FamilyType = "sf")

# select columns that are collected in the whole years
mf_data <- mf_data %>% 
  select(1:15, 17:18, 40)

sf_data <- sf_data %>% 
  select(1:35, 37:41, 67)

data <- bind_rows(mf_data, sf_data)

write_csv(sf_data, "sf_loan_data.csv")
write_csv(mf_data, "mf_loan_data.csv")
write_csv(data, "loan_data.csv")
```

```{r}
# count the number of sf and mf loans for each tract and calculate medians of income and upd.

tract_sf_loans <- data %>% filter(FamilyType == "sf", BorrowersIncome < 999999999, UPB < 999999999, Age < 9) %>% 
  group_by(Tract) %>% 
  summarise(sf_num_loans = n(), sf_med_income = median(BorrowersIncome), sf_med_upb = median(UPB), mode_race = mfv(Race_1), mean_age = mean(Age))

tract_mf_loans <- data %>% filter(FamilyType == "mf") %>% 
  group_by(Tract) %>% 
  summarise(mf_num_loans = n(), mf_med_upb = median(UPB))

tract_loans <- full_join(tract_sf_loans, tract_mf_loans, by = c("Tract" = "Tract"))
```

```{r}
PA_state_plane <- "+proj=lcc +lat_1=41.95 +lat_2=40.88333333333333 +lat_0=40.16666666666666 +lon_0=-77.75 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs"

tracts <- tracts("PA", "003") %>% 
  st_transform(PA_state_plane)

# The number of tracts collected from FHFA is different from that of tigris. FHFA contains 446 tracts though the tigris contains only 402.

tract_loans <- full_join(tract_loans, tracts, by = c("Tract" = "TRACTCE"))
# tract_loans <- mutate_at(tract_loans, c("sf_num_loans", "mf_num_loans", "sf_med_income", "sf_med_upb", "mf_med_upb"), ~replace(., is.na(.), 0))

tract_loans <- tract_loans %>% 
  mutate(family = case_when(sf_num_loans > 0 & mf_num_loans > 0 ~ "Single Family and Multi Family",
                             sf_num_loans > 0 & is.na(mf_num_loans) ~ "Single Family only",
                             is.na(sf_num_loans) & mf_num_loans > 0 ~ "Single Family only",
                             is.na(sf_num_loans) & is.na(mf_num_loans) ~ "None"
                             ))
# load river data
river <- read_sf("https://openac-alcogis.opendata.arcgis.com/datasets/def3bd39f12d408c9bd097f5a3b3b136_0.geojson?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D") %>% 
  st_transform(PA_state_plane)
```


```{r}
tract_loans %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = family), color = "gray70") +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  scale_fill_manual(values = c("white", "greenyellow", "tomato")) +
  theme_map() +
  labs(title = "Loans based on family type", fill = "Family type") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) 
```

```{r}

ggplot(river) +
  geom_sf(data = river, fill = "blue", color = NA)

tract_loans %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = sf_num_loans, color = "")) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  theme_map() +
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white") +
  scale_color_manual(values = NA, name = "No data") +
  labs(title = "Number of single-family loans", fill = "n") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```

```{r}
tract_loans %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = mf_num_loans, color = "")) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  theme_map()+
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white") +
  scale_color_manual(values = NA, name = "No data") +
  labs(title = "Number of multi-family loans", fill = "n") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```

```{r}
tract_loans %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = mf_med_upb, color = "")) +
  theme_map()+
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white", labels = comma) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  scale_color_manual(values = NA, name = "No data") + 
  labs(title = "Multi-family median unpaid principal balance (UPD)", fill = "$") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```

```{r}
tract_loans %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = sf_med_upb, color = "")) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  theme_map()+
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white", labels = comma) +
  scale_color_manual(values = NA, name = "No data") + 
  labs(title = "Single-family median unpaid principal balance (UPD)", fill = "$") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```

```{r}
tract_loans %>% filter(sf_med_income < 5000000) %>% 
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = sf_med_income, color = "")) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  theme_map()+
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white", labels = comma) +
  scale_color_manual(values = NA, name = "No data") + 
  labs(title = "Single-family median income", fill = "$") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```

```{r}
tract_loans %>%
  ggplot() +
  geom_sf(aes(
    geometry = geometry,
    fill = as.factor(mode_race)
  )) +
  geom_sf(
    data = river,
    fill = "blue",
    color = NA,
    alpha = 1 / 3
  ) +
  theme_map() +
  scale_fill_manual(
    values = c("orange", "greenyellow", "tomato"),
    name = "Race",
    labels = c("Black or African American", "White", "information not provided"),
    na.value = "white"
  ) +
  labs(title = "Single-family loan mode of race") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill = alpha("white", 0.5)))

```

```{r}
tract_loans %>%
  ggplot() + 
  geom_sf(aes(geometry = geometry, fill = mean_age, color = "")) +
  geom_sf(data = river, fill = "blue", color = NA, alpha = 1/3) +
  theme_map()+
  scale_fill_gradientn(colors = c("greenyellow", "orange", "tomato"), na.value = "white", labels = c("~25", "25~34", "35~44", "45~54", "55~64", "65~74", "74~")) +
  scale_color_manual(values = NA, name = "No data") + 
  labs(title = "Single-family mean age", fill = "Age") +
  theme(legend.position = c(0, 0),
        legend.background = element_rect(fill=alpha("white", 0.5))) +
  guides(color=guide_legend("No data", override.aes=c(fill="white")))
```




## Linear Regression

Dependent variable: interest rate

Independent variable: income, loan amount, age, gender, race, loan term















## Tasks

* Load data files for all years (use `rbind()`).
* Generate a summary dataframe with the following variables at the census tract level:
    + Average number of single-family loans per year
```{r}
sf_avg_year <- data %>%
  filter(FamilyType == "sf") %>% 
  group_by(year) %>% 
  summarise(num_loans = n())

ggplot(sf_avg_year) +
  geom_bar(aes(as.character(year), num_loans), stat = "identity") +
  labs(x = "Year", y = "Number of loans", title = "Number of single-family loans per year") +
  theme_classic() +
  geom_hline(yintercept = mean(sf_avg_year$num_loans), color = "red")
```

    + Average number of multifamily loans per year
```{r}
mf_avg_year <- data %>%
  filter(FamilyType == "mf") %>% 
  group_by(year) %>% 
  summarise(num_loans = n())

ggplot(mf_avg_year) +
  geom_bar(aes(as.character(year), num_loans), stat = "identity") +
  labs(x = "Year", y = "Number of loans", title = "Number of multi-family loans per year") +
  theme_classic() +
  geom_hline(yintercept = mean(mf_avg_year$num_loans), color = "red")
```

    + Average number of loans per year by loan purpose
```{r}
data$Purpose <- as.character(data$Purpose)
avg_year_purpose <- data %>% 
  group_by(year, Purpose) %>% 
  summarise(num_loans = n())

ggplot(avg_year_purpose) +
  geom_bar(aes(x = year, y = num_loans, fill = Purpose), 
           stat = "identity", position = position_dodge(width = 1)) +
  labs(x = "Year", y = "Number of loans", title = "Number of purpose-wise loans per year") +
  scale_fill_hue(labels = c("Purchase", "Refinancing(non cash-out)", "Home Improvement", "Refinancing (cash-out)", "Not applicable/Not available"))
```

    + Average number of units for multifamily loans
```{r}
avg_nunits <- data %>% 
  filter(FamilyType == "mf" & num_loans != "NA")

avg_nunits <- (
  sum(avg_nunits$numUnits == 1) * (5 + 24) / 2 +
    sum(avg_nunits$numUnits == 2) * (25 + 50) / 2 +
    sum(avg_nunits$numUnits == 3) * (51 + 99) / 2 +
    sum(avg_nunits$numUnits == 4) * (100 + 149) / 2 +
    sum(avg_nunits$numUnits == 5) * (200) / 20
) /
  sum(avg_nunits$numUnits != 9)

data %>% 
  filter(FamilyType == "mf" & numUnits != "NA") %>%
  ggplot() +
  geom_bar(aes(x = year, fill = as.character(numUnits)), 
           position = position_dodge(width = 1)) +
  labs(x = "Year", y = "Count", title = "Number of units for multi-family loans per year", fill = "Number of units") +
  scale_fill_hue(labels = c("5-24", "25-50", "51-99", "100-149", "over 149", "Unknown"))
```

    + Average percent of affordable units
```{r}
avgpct_afford <- data %>% 
  filter(pctAfford != "NA") %>% 
  summarize(mean(pctAfford))
  
avgpct_afford
```

    + Is it an opportunity zone?
```{r}
opp_zone <- data %>% 
  filter(QOZ != "NA") %>% 
  summarize(mean(QOZ))

opp_zone
```

    + Other tract-level variables about lending you think could be interesting?

```{r}
data %>% group_by(EntFlag) %>%
  filter(BorrowersIncome < 9999999) %>%
  ggplot() + 
  geom_jitter(aes(x = as.factor(EntFlag), y = BorrowersIncome)) +
  labs(x = "Enterprise type", y = "Borrower's income", title = "Enterprise-wise borrowers income") +
  scale_x_discrete(labels = c("Fannie Mae", "Freddie Mac")) +
  ylim(0, 1250000)
```

```{r}
data %>% filter(Race_1 <= 5, BorrowersIncome <= 250000) %>%
  ggplot() +
  geom_boxplot(aes(as.factor(Race_1), BorrowersIncome)) +
  labs(x = "Race", y = "Borrower's income", title = "Race-wise borrowers income") +
  scale_x_discrete(labels = c("American Indian or Alaska Native", "Asian", "African American", "Native Hawaiian", "White")) 
```

```{r}
sf_data %>% filter(Race_1 <=5, rate >= 0, rate < 25) %>% 
  ggplot() +
  geom_boxplot(aes(as.factor(Race_1), rate, fill = as.factor(Race_1)))
```

```{r}
sf_data %>% filter(Race_1 <= 5, amt < 999999999, amt > 0) %>% 
  ggplot() +
  geom_boxplot(aes(as.factor(Race_1), amt, fill = as.factor(Race_1)))
```
```{r}
sf_data %>% filter(Race_1 <=5, amt < 599999999, amt > 0, rate >= 0, rate < 7) %>% 
  ggplot(aes(Term, rate)) +
  geom_point(aes(color = as.factor(Race_1))) +
  geom_smooth() +
  facet_wrap(~ Race_1)


sf_data %>% filter(Race_1 <=5, Term == 360, rate < 10, amt < 599999999, BorrowersIncome < 90000, BorrowersIncome > 60000) %>% 
  group_by(Race_1) %>% 
  summarise(median(rate), median(amt), median(BorrowersIncome))
```


